<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>{% block title %}Users{% endblock %}</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="min-h-screen">
    <header class="border-b bg-white">
        <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">U</div>
                <div>
                    <div class="font-semibold">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                    <div class="text-xs text-slate-500">Ø§ÙØ²ÙˆØ¯Ù†ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                </div>
            </div>
            <div class="text-xs text-slate-500">
                <span id="weatherBox">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§â€¦</span>
            </div>
            <nav class="flex items-center gap-2">
                <a href="/users" class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800">Ù„ÛŒØ³Øª
                    Ú©Ø§Ø±Ø¨Ø±</a>
                <a href="/niksalehi" class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800">Ø³Ø§ÛŒØª</a>
            </nav>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <footer class="py-8 text-center text-xs text-slate-500">
        Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¨Ø§ FastAPI + SQLAlchemy + Tailwind
    </footer>
</div>
<script>
  const box = document.getElementById("weatherBox");
  const DEFAULT_CITY = "ØªÙ‡Ø±Ø§Ù†";

  function wmoText(code) {
    const m = {
      0:"ØµØ§Ù",1:"Ø¹Ù…Ø¯ØªØ§Ù‹ ØµØ§Ù",2:"Ù†ÛŒÙ…Ù‡â€ŒØ§Ø¨Ø±ÛŒ",3:"Ø§Ø¨Ø±ÛŒ",
      61:"Ø¨Ø§Ø±Ø§Ù†",63:"Ø¨Ø§Ø±Ø§Ù† Ù…ØªÙˆØ³Ø·",65:"Ø¨Ø§Ø±Ø§Ù† Ø´Ø¯ÛŒØ¯",
      71:"Ø¨Ø±Ù",95:"Ø±Ø¹Ø¯ÙˆØ¨Ø±Ù‚"
    };
    return m[code] || ("Ú©Ø¯ " + code);
  }

  async function loadWeather(lat, lon) {
    const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
    if (!res.ok) throw new Error("weather api error");
    const data = await res.json();
    const c = data.current;
    return `ğŸŒ¤ï¸ ${Math.round(c.temperature_2m)}Â°C â€¢ ${wmoText(c.weather_code)} â€¢ ğŸ’¨ ${Math.round(c.wind_speed_10m)} km/h`;
  }

  async function geocodeCity(city) {
    const res = await fetch(`/api/geocode?city=${encodeURIComponent(city)}&count=1`);
    if (!res.ok) throw new Error("geocode error");
    const arr = await res.json();
    if (!arr.length) throw new Error("city not found");
    return {
      lat: arr[0].latitude,
      lon: arr[0].longitude,
      label: `${arr[0].name} ${arr[0].admin1||""}`.trim()
    };
  }

  async function loadCityWeather(city) {
    try {
      box.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§â€¦";
      const {lat, lon, label} = await geocodeCity(city);
      const text = await loadWeather(lat, lon);
      box.textContent = `ğŸ“ ${label} â€” ${text}`;
    } catch (e) {
      box.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§";
    }
  }

  function showCityInput(msg) {
    box.innerHTML = `
      <span class="text-slate-600">${msg}</span>
      <form id="cityForm" class="inline-flex items-center gap-2 mr-2">
        <input id="cityInput"
               class="rounded-lg border px-2 py-1 text-xs"
               value="${DEFAULT_CITY}"
               placeholder="Ù†Ø§Ù… Ø´Ù‡Ø±" />
        <button class="rounded-lg bg-slate-900 text-white px-2 py-1 text-xs">
          Ø«Ø¨Øª
        </button>
      </form>
    `;

    const form = document.getElementById("cityForm");
    const input = document.getElementById("cityInput");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const city = input.value.trim() || DEFAULT_CITY;
      localStorage.setItem("weather_city", city);
      await loadCityWeather(city);
    });
  }

  (async () => {
    try {
      if (!navigator.geolocation) {
        showCityInput("Ù„ÙˆÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:");
        await loadCityWeather(DEFAULT_CITY);
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const text = await loadWeather(lat, lon);
          box.textContent = text;
        },
        async () => {
          showCityInput("Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³ØªØ› Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:");
          await loadCityWeather(DEFAULT_CITY);
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 600000 }
      );
    } catch (e) {
      await loadCityWeather(DEFAULT_CITY);
    }
  })();
</script>
</body>
</html>